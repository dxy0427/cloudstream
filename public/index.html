<!doctype html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
    <meta http-equiv="X-UA-Compatible" content="ie=edge"/>
    <title>CloudStream ÊéßÂà∂Èù¢Êùø</title>
    <link href="https://cdn.jsdelivr.net/npm/@tabler/core@1.0.0-beta20/dist/css/tabler.min.css" rel="stylesheet"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"/>
    <link rel="icon" href="data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20viewBox%3D%220%200%20100%20100%22%3E%3Ctext%20y%3D%22.9em%22%20font-size%3D%2290%22%3EüöÄ%3C%2Ftext%3E%3C%2Fsvg%3E">
    <style> .page-center { min-height: 100vh; } </style>
</head>
<body>
    <div id="app">
        <div class="page page-center">
            <div class="container-tight py-4">
                <div class="empty">
                    <div class="empty-icon"><div class="spinner-border"></div></div>
                    <p class="empty-title">Ê≠£Âú®Âä†ËΩΩÂ∫îÁî®...</p>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@tabler/core@1.0.0-beta20/dist/js/tabler.min.js"></script>
    <script>
    const API_BASE = '/api/v1';
    const templates = {
        loginPage: `
            <div class="page page-center">
                <div class="container container-tight py-4">
                    <div class="text-center mb-4"><h1>üöÄ CloudStream</h1></div>
                    <div class="card card-md">
                        <div class="card-body">
                            <h2 class="h2 text-center mb-4">ÁôªÂΩïÊÇ®ÁöÑÊéßÂà∂Èù¢Êùø</h2>
                            <div id="error-alert" class="alert alert-danger d-none" role="alert"></div>
                            <div class="mb-3">
                                <label class="form-label">Áî®Êà∑Âêç</label>
                                <input type="text" id="login-username" class="form-control" placeholder="È¶ñÊ¨°ÂêØÂä®Ë¥¶Âè∑‰∏∫ admin">
                            </div>
                            <div class="mb-2">
                                <label class="form-label">ÂØÜÁ†Å</label>
                                <input type="password" id="login-password" class="form-control" placeholder="È¶ñÊ¨°ÂêØÂä®ÂØÜÁ†Å‰∏∫ admin">
                            </div>
                            <div class="form-footer">
                                <button id="login-btn" class="btn btn-primary w-100">Áôª ÂΩï</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `,
        mainPage: `
            <div class="page">
                <header class="navbar navbar-expand-md d-print-none">
                    <div class="container-xl">
                        <h1 class="navbar-brand navbar-brand-autodark d-none-navbar-horizontal pe-0 pe-md-3">üöÄ CloudStream ÊéßÂà∂Èù¢Êùø</h1>
                        <div class="navbar-nav flex-row order-md-last">
                            <div class="nav-item dropdown">
                                <a href="#" class="nav-link d-flex lh-1 text-reset p-0" data-bs-toggle="dropdown">
                                    <span class="avatar avatar-sm"><<i class="fa-solid fa-user"></</i></span>
                                    <div class="d-none d-xl-block ps-2"><div id="current-username">User</div></div>
                                </a>
                                <div class="dropdown-menu dropdown-menu-end dropdown-menu-arrow">
                                    <a href="#" id="security-settings-btn" class="dropdown-item">Ë¥¶Êà∑ÂÆâÂÖ®</a>
                                    <a href="#" id="logout-btn" class="dropdown-item">ÈÄÄÂá∫ÁôªÂΩï</a>
                                </div>
                            </div>
                        </div>
                    </div>
                </header>
                <div class="page-wrapper">
                    <div class="page-body">
                        <div class="container-xl">
                            <div class="row g-4">
                                <!-- ‰∫ëË¥¶Êà∑ÁÆ°ÁêÜ -->
                                <div class="col-lg-12">
                                    <div class="card">
                                        <div class="card-header">
                                            <h3 class="card-title"><<i class="fa-solid fa-cloud me-2 text-primary"></</i>‰∫ëË¥¶Êà∑ÁÆ°ÁêÜ</h3>
                                            <div class="ms-auto">
                                                <button id="add-account-btn" class="btn btn-primary"><<i class="fa-solid fa-plus me-2"></</i>Ê∑ªÂä†Ë¥¶Êà∑</button>
                                            </div>
                                        </div>
                                        <div id="account-list" class="list-group list-group-flush list-group-hoverable">
                                            <div class="list-group-item text-center text-secondary py-4">Ê≠£Âú®Âä†ËΩΩË¥¶Êà∑...</div>
                                        </div>
                                    </div>
                                </div>
                                <!-- ‰ªªÂä°ÈÖçÁΩÆ -->
                                <div class="col-lg-12">
                                    <div class="card">
                                        <div class="card-header">
                                            <h3 class="card-title"><<i class="fa-solid fa-tasks me-2 text-success"></</i>‰ªªÂä°ÈÖçÁΩÆ</h3>
                                            <div class="ms-auto">
                                                <button id="add-task-btn" class="btn btn-success"><<i class="fa-solid fa-plus me-2"></</i>Ê∑ªÂä†‰ªªÂä°</button>
                                            </div>
                                        </div>
                                        <div class="table-responsive">
                                            <table class="table card-table table-vcenter text-nowrap">
                                                <thead>
                                                    <tr>
                                                        <<th>‰ªªÂä°ÂêçÁß∞</</th>
                                                        <<th>ÊâÄÂ±ûË¥¶Êà∑</</th>
                                                        <<th>Á∫øÁ®ãÊï∞</</th>
                                                        <<th>‰∫ëÁõòÁõÆÂΩïID</</th>
                                                        <<th>Êú¨Âú∞Ë∑ØÂæÑ</</th>
                                                        <<th>ÂêåÊ≠•È¢ëÁéá</</th>
                                                        <<th class="text-end">Êìç‰Ωú</</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="task-table-body"></tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `,
        securityModal: `
            <div class="modal modal-blur fade" id="security-modal" tabindex="-1">
                <div class="modal-dialog modal-sm modal-dialog-centered">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Ë¥¶Êà∑ÂÆâÂÖ®</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <div class="mb-3">
                                <label class="form-label">Êñ∞Áî®Êà∑Âêç</label>
                                <input type="text" id="newUsername" class="form-control">
                                <small class="form-hint">ÁïôÁ©∫Âàô‰∏ç‰øÆÊîπÁî®Êà∑Âêç</small>
                            </div>
                            <hr class="my-3">
                            <div class="mb-3">
                                <label class="form-label">Êñ∞ÂØÜÁ†Å</label>
                                <input type="password" id="newPassword" class="form-control" placeholder="ÁïôÁ©∫Âàô‰∏ç‰øÆÊîπÂØÜÁ†Å">
                            </div>
                            <div class="mb-2">
                                <label class="form-label">Á°ÆËÆ§Êñ∞ÂØÜÁ†Å</label>
                                <input type="password" id="confirmPassword" class="form-control">
                            </div>
                            <hr class="my-3">
                            <div class="mb-2">
                                <label class="form-label">ÂΩìÂâçÂØÜÁ†Å <span class="text-danger">*</span></label>
                                <input type="password" id="currentPassword" class="form-control" placeholder="ÂøÖÈ°ªÂ°´ÂÜô‰ª•Á°ÆËÆ§Êõ¥Êîπ">
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn me-auto" data-bs-dismiss="modal">ÂèñÊ∂à</button>
                            <button type="button" id="update-credentials-btn" class="btn btn-primary">Á°ÆËÆ§‰øÆÊîπ</button>
                        </div>
                    </div>
                </div>
            </div>
        `,
        accountModal: `
            <div class="modal modal-blur fade" id="account-modal" tabindex="-1">
                <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 id="account-modal-title" class="modal-title">Ê∑ªÂä†‰∫ëË¥¶Êà∑</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <input type="hidden" id="account-id">
                            <div class="row g-3">
                                <div class="col-md-12">
                                    <label class="form-label">Ë¥¶Êà∑ÂêçÁß∞ <span class="text-danger">*</span></label>
                                    <input type="text" id="accountName" class="form-control" placeholder="‰æãÂ¶ÇÔºöÊàëÁöÑÂ§ßÂè∑">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">123Pan Client ID <span class="text-danger">*</span></label>
                                    <input type="text" id="clientID" class="form-control">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">123Pan Client Secret <span class="text-danger">*</span></label>
                                    <input type="password" id="clientSecret" class="form-control">
                                </div>
                                <div class="col-md-12">
                                    <label class="form-label">STRM Êñá‰ª∂Âü∫Á°Ä URL <span class="text-danger">*</span></label>
                                    <input type="text" id="strmBaseURL" class="form-control" placeholder="http://172.17.0.1:12398 [Êé®ËçêÂÜÖÁΩëÂú∞ÂùÄ]">
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" id="test-conn-btn" class="btn btn-outline-info me-auto">ÊµãËØïËøûÊé•</button>
                            <button type="button" class="btn" data-bs-dismiss="modal">ÂèñÊ∂à</button>
                            <button type="button" id="save-account-btn" class="btn btn-primary">‰øùÂ≠òË¥¶Êà∑</button>
                        </div>
                    </div>
                </div>
            </div>
        `,
        taskModal: `
            <div class="modal modal-blur fade" id="task-modal" tabindex="-1">
                <div class="modal-dialog modal-lg modal-dialog-centered">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Ê∑ªÂä†‰ªªÂä°</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label class="form-label">‰ªªÂä°ÂêçÁß∞ <span class="text-danger">*</span></label>
                                    <input type="text" id="taskName" class="form-control">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">ÊâÄÂ±û‰∫ëË¥¶Êà∑ <span class="text-danger">*</span></label>
                                    <select id="taskAccountID" class="form-select"></select>
                                </div>
                                <div class="col-md-12">
                                    <label class="form-label">‰∫ëÁõòÁõÆÂΩï ID <span class="text-danger">*</span></label>
                                    <div class="input-group">
                                        <input type="text" id="sourceFolderID" class="form-control">
                                        <button id="browse-folder-btn" class="btn">ÊµèËßà</button>
                                    </div>
                                </div>
                                <div class="col-md-12">
                                    <label class="form-label">Êú¨Âú∞Ë∑ØÂæÑ(ÂÆπÂô®ÂÜÖ) <span class="text-danger">*</span></label>
                                    <input type="text" id="localPath" class="form-control">
                                </div>
                                <div class="col-md-7">
                                    <label class="form-label">‰ªªÂä°Á∫øÁ®ãÊï∞ (QPS): <span id="threads-value" class="badge bg-primary">4</span></label>
                                    <input type="range" id="taskThreads" class="form-range" min="1" max="8" step="1" value="4">
                                </div>
                                <div class="col-md-5 d-flex align-items-end">
                                    <label class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="overwriteMode">
                                        <span class="form-check-label">Ë¶ÜÁõñÊ®°Âºè</span>
                                    </label>
                                    <span class="form-hint ms-2" data-bs-toggle="tooltip" title="ÂºÄÂêØÂêéÔºåÊØèÊ¨°ÊâßË°å‰ªªÂä°ÈÉΩ‰ºöÈáçÊñ∞ÁîüÊàêÊâÄÊúâÊñá‰ª∂„ÄÇ">?</span>
                                </div>
                                <div class="col-md-12">
                                    <label class="form-label">ÂêåÊ≠•È¢ëÁéá(CRON) <span class="text-danger">*</span></label>
                                    <input type="text" id="taskCron" class="form-control">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">STRM Êñá‰ª∂ÂêéÁºÄ</label>
                                    <textarea id="strmExtensions" class="form-control" rows="2"></textarea>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">ÂÖÉÊï∞ÊçÆÊñá‰ª∂ÂêéÁºÄ</label>
                                    <textarea id="metaExtensions" class="form-control" rows="2"></textarea>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn me-auto" data-bs-dismiss="modal">ÂèñÊ∂à</button>
                            <button type="button" id="save-task-btn" class="btn btn-primary">Á°ÆËÆ§‰øùÂ≠ò</button>
                        </div>
                    </div>
                </div>
            </div>
        `,
        fileBrowserModal: `
            <div class="modal modal-blur fade" id="file-browser-modal" tabindex="-1">
                <div class="modal-dialog modal-lg modal-dialog-centered">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">ÊµèËßà‰∫ëÁõòÁõÆÂΩï</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <div id="file-browser" class="border rounded p-2" style="min-height: 20rem; max-height: 60vh; overflow-y: auto;"></div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn" data-bs-dismiss="modal">ÂÖ≥Èó≠</button>
                        </div>
                    </div>
                </div>
            </div>
        `
    };

    class App {
        constructor() {
            this.token = localStorage.getItem('jwt_token');
            this.modals = {};
            this.refreshInterval = null;
            this.accounts = [];
            this.browserState = { path: [] };
        }

        run() {
            clearInterval(this.refreshInterval);
            document.body.querySelectorAll('.modal').forEach(m => m.remove());
            this.token ? this.renderMainPage() : this.renderLoginPage();
        }

        renderLoginPage() {
            document.getElementById('app').innerHTML = templates.loginPage;
            this.initLoginPage();
        }

        renderMainPage() {
            document.getElementById('app').innerHTML = templates.mainPage;
            // ÊèíÂÖ•ÊâÄÊúâÊ®°ÊÄÅÊ°Ü
            document.body.insertAdjacentHTML('beforeend', templates.securityModal);
            document.body.insertAdjacentHTML('beforeend', templates.accountModal);
            document.body.insertAdjacentHTML('beforeend', templates.taskModal);
            document.body.insertAdjacentHTML('beforeend', templates.fileBrowserModal);
            this.initMainPage();
        }

        initLoginPage() {
            // ÁôªÂΩïÊåâÈíÆÁÇπÂáª‰∫ã‰ª∂
            document.getElementById('login-btn').addEventListener('click', () => this.handleLogin());
            // ÂØÜÁ†ÅÊ°ÜÂõûËΩ¶ÁôªÂΩï
            document.getElementById('login-password').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') this.handleLogin();
            });
            // ËÅöÁÑ¶Áî®Êà∑ÂêçËæìÂÖ•Ê°Ü
            document.getElementById('login-username').focus();
        }

        initMainPage() {
            // ÂàùÂßãÂåñÊ®°ÊÄÅÊ°Ü
            this.modals.security = new bootstrap.Modal(document.getElementById('security-modal'));
            this.modals.account = new bootstrap.Modal(document.getElementById('account-modal'));
            this.modals.task = new bootstrap.Modal(document.getElementById('task-modal'));
            this.modals.fileBrowser = new bootstrap.Modal(document.getElementById('file-browser-modal'));
            // ÂàùÂßãÂåñÊèêÁ§∫Â∑•ÂÖ∑
            new bootstrap.Tooltip(document.body, { selector: '[data-bs-toggle="tooltip"]' });

            // ÁªëÂÆöÈ°∂ÈÉ®ËèúÂçï‰∫ã‰ª∂
            document.getElementById('logout-btn').addEventListener('click', () => this.handleLogout());
            document.getElementById('security-settings-btn').addEventListener('click', () => this.openSecurityModal());
            // Ë¥¶Êà∑ÂÆâÂÖ®Ê®°ÊÄÅÊ°Ü‰∫ã‰ª∂
            document.getElementById('update-credentials-btn').addEventListener('click', () => this.updateCredentials());

            // ‰∫ëË¥¶Êà∑ÁÆ°ÁêÜ‰∫ã‰ª∂
            document.getElementById('add-account-btn').addEventListener('click', () => this.openAccountModal());
            document.getElementById('save-account-btn').addEventListener('click', () => this.saveAccount());
            document.getElementById('test-conn-btn').addEventListener('click', () => this.testConnection());

            // ‰ªªÂä°ÈÖçÁΩÆ‰∫ã‰ª∂
            document.getElementById('add-task-btn').addEventListener('click', () => this.openTaskModal());
            document.getElementById('save-task-btn').addEventListener('click', () => this.saveTask());
            // Á∫øÁ®ãÊï∞ÊªëÂùóÂêåÊ≠•ÊòæÁ§∫
            document.getElementById('taskThreads').addEventListener('input', (e) => {
                document.getElementById('threads-value').textContent = e.target.value;
            });

            // Âä†ËΩΩÊâÄÊúâÊï∞ÊçÆ
            this.loadAllData();
            // ÂÆöÊó∂Âà∑Êñ∞‰ªªÂä°Áä∂ÊÄÅÔºà5Áßí‰∏ÄÊ¨°Ôºâ
            this.refreshInterval = setInterval(() => this.loadTasks(true), 5000);
        }

        async loadAllData() {
            await this.loadUsername();
            await this.loadAccounts();
            await this.loadTasks(false);
        }

        async handleLogin() {
            const username = document.getElementById('login-username').value;
            const password = document.getElementById('login-password').value;
            const errorAlert = document.getElementById('error-alert');

            try {
                const res = await fetch(`${API_BASE}/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });
                const data = await res.json();
                if (!res.ok) throw new Error(data.error || 'ÁôªÂΩïÂ§±Ë¥•');

                localStorage.setItem('jwt_token', data.token);
                this.token = data.token;
                this.run();
            } catch (err) {
                errorAlert.textContent = err.message;
                errorAlert.classList.remove('d-none');
            }
        }

        handleLogout() {
            localStorage.removeItem('jwt_token');
            this.token = null;
            this.run();
        }

        async fetchAPI(endpoint, options = {}) {
            const headers = {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${this.token}`,
                ...options.headers
            };

            try {
                const res = await fetch(`${API_BASE}${endpoint}`, { ...options, headers });
                // 401 Áõ¥Êé•ÁôªÂá∫
                if (res.status === 401) {
                    this.handleLogout();
                    throw new Error('ËÆ§ËØÅÂ∑≤ËøáÊúüÔºåËØ∑ÈáçÊñ∞ÁôªÂΩï');
                }

                const data = await res.json();
                // ‰∏öÂä°ÈîôËØØÊäõÂá∫ÂºÇÂ∏∏
                if (!res.ok) throw new Error(data.error || data.message || 'ËØ∑Ê±ÇÂ§±Ë¥•');
                if (res.ok && data.code !== 0) throw new Error(data.message || 'Êìç‰ΩúÂ§±Ë¥•');

                return data;
            } catch (err) {
                if (!options.silent) this.showToast(err.message, true);
                return null;
            }
        }

        async loadUsername() {
            const res = await this.fetchAPI('/username');
            if (res) document.getElementById('current-username').textContent = res.data.username;
        }

        openSecurityModal() {
            // Ê∏ÖÁ©∫ËæìÂÖ•Ê°Ü
            document.getElementById('currentPassword').value = '';
            document.getElementById('newPassword').value = '';
            document.getElementById('confirmPassword').value = '';
            // Âä†ËΩΩÂΩìÂâçÁî®Êà∑ÂêçÂà∞Êñ∞Áî®Êà∑ÂêçËæìÂÖ•Ê°Ü
            this.loadUsername().then(() => {
                document.getElementById('newUsername').value = document.getElementById('current-username').textContent;
            });
            this.modals.security.show();
        }

        async updateCredentials() {
            const payload = {
                newUsername: document.getElementById('newUsername').value.trim(),
                currentPassword: document.getElementById('currentPassword').value,
                newPassword: document.getElementById('newPassword').value,
                confirmPassword: document.getElementById('confirmPassword').value
            };

            // Âü∫Á°ÄÊ†°È™å
            if (!payload.currentPassword) {
                this.showToast('ÂøÖÈ°ªÂ°´ÂÜôÂΩìÂâçÂØÜÁ†Å‰ª•Á°ÆËÆ§Êõ¥Êîπ', true);
                return;
            }
            if (payload.newPassword !== payload.confirmPassword) {
                this.showToast('‰∏§Ê¨°ËæìÂÖ•ÁöÑÊñ∞ÂØÜÁ†Å‰∏ç‰∏ÄËá¥', true);
                return;
            }

            const res = await this.fetchAPI('/update_credentials', {
                method: 'POST',
                body: JSON.stringify(payload)
            });

            if (res) {
                this.showToast('Âá≠ËØÅÊõ¥Êñ∞ÊàêÂäüÔºåËØ∑ÈáçÊñ∞ÁôªÂΩï„ÄÇ');
                this.modals.security.hide();
                setTimeout(() => this.handleLogout(), 1500);
            }
        }

        async loadAccounts() {
            const res = await this.fetchAPI('/accounts');
            const list = document.getElementById('account-list');
            list.innerHTML = '';

            if (!res || !res.data || res.data.length === 0) {
                list.innerHTML = '<div class="list-group-item text-center text-secondary py-4">ÊöÇÊó†‰∫ëË¥¶Êà∑ÔºåËØ∑Ê∑ªÂä†‰∏Ä‰∏™</div>';
                this.accounts = [];
                return;
            }

            // ÊåâIDÂçáÂ∫èÊéíÂ∫è
            this.accounts = res.data.sort((a, b) => a.ID - b.ID);

            this.accounts.forEach(acc => {
                const item = document.createElement('div');
                item.className = 'list-group-item';
                item.innerHTML = `
                    <div class="row align-items-center">
                        <div class="col text-truncate">
                            <strong>${acc.Name}</strong>
                            <div class="d-block text-secondary text-truncate mt-n1">Client ID: ${acc.ClientID}</div>
                        </div>
                        <div class="col-auto">
                            <button class="btn btn-outline-secondary btn-sm me-2">ÁºñËæë</button>
                            <button class="btn btn-outline-danger btn-sm">Âà†Èô§</button>
                        </div>
                    </div>
                `;
                // ÁªëÂÆöÁºñËæë/Âà†Èô§‰∫ã‰ª∂
                item.querySelector('.btn-outline-secondary').addEventListener('click', () => this.openAccountModal(acc));
                item.querySelector('.btn-outline-danger').addEventListener('click', () => this.deleteAccount(acc.ID));
                list.appendChild(item);
            });
        }

        openAccountModal(account = null) {
            const isEdit = account !== null;
            // ËÆæÁΩÆÊ®°ÊÄÅÊ°ÜÊ†áÈ¢ò
            document.getElementById('account-modal-title').textContent = isEdit 
                ? `ÁºñËæë‰∫ëË¥¶Êà∑: ${account.Name}` 
                : 'Ê∑ªÂä†‰∫ëË¥¶Êà∑';
            // Â°´ÂÖÖË°®ÂçïÊï∞ÊçÆ
            document.getElementById('account-id').value = isEdit ? account.ID : '';
            document.getElementById('accountName').value = isEdit ? account.Name : '';
            document.getElementById('clientID').value = isEdit ? account.ClientID : '';
            document.getElementById('clientSecret').value = isEdit ? account.ClientSecret : '';
            document.getElementById('strmBaseURL').value = isEdit ? account.StrmBaseURL : '';

            this.modals.account.show();
        }

        async saveAccount() {
            const id = document.getElementById('account-id').value;
            const payload = {
                ID: id ? parseInt(id) : 0,
                Name: document.getElementById('accountName').value.trim(),
                ClientID: document.getElementById('clientID').value.trim(),
                ClientSecret: document.getElementById('clientSecret').value.trim(),
                StrmBaseURL: document.getElementById('strmBaseURL').value.trim()
            };

            // Âü∫Á°ÄÊ†°È™å
            if (!payload.Name || !payload.ClientID || !payload.ClientSecret) {
                this.showToast('Ë¥¶Êà∑ÂêçÁß∞ÂíåÂá≠ËØÅ‰∏çËÉΩ‰∏∫Á©∫', true);
                return;
            }

            const method = id ? 'PUT' : 'POST';
            const endpoint = id ? `/accounts/${id}` : '/accounts';
            const res = await this.fetchAPI(endpoint, {
                method,
                body: JSON.stringify(payload)
            });

            if (res) {
                this.showToast(`‰∫ëË¥¶Êà∑‰øùÂ≠òÊàêÂäü!`);
                this.modals.account.hide();
                await this.loadAccounts();
            }
        }

        async deleteAccount(id) {
            if (!confirm('Á°ÆÂÆöË¶ÅÂà†Èô§Ê≠§‰∫ëË¥¶Êà∑ÂêóÔºüÊâÄÊúâÂÖ≥ËÅîÁöÑ‰ªªÂä°‰πüÂ∞ÜË¢´‰∏ÄÂπ∂Âà†Èô§ÔºÅ')) return;
            const res = await this.fetchAPI(`/accounts/${id}`, { method: 'DELETE' });
            if (res) {
                this.showToast('‰∫ëË¥¶Êà∑Âà†Èô§ÊàêÂäü!');
                await this.loadAccounts();
                await this.loadTasks();
            }
        }

        async testConnection() {
            const btn = document.getElementById('test-conn-btn');
            const originalText = btn.innerHTML;
            // ÊåâÈíÆÂä†ËΩΩÁä∂ÊÄÅ
            btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>ÊµãËØï‰∏≠...';
            btn.disabled = true;

            const payload = {
                ClientID: document.getElementById('clientID').value.trim(),
                ClientSecret: document.getElementById('clientSecret').value.trim()
            };

            const res = await this.fetchAPI('/accounts/test', {
                method: 'POST',
                body: JSON.stringify(payload)
            });

            if (res) this.showToast(res.message);
            // ÊÅ¢Â§çÊåâÈíÆÁä∂ÊÄÅ
            btn.innerHTML = originalText;
            btn.disabled = false;
        }

        async loadTasks(isSilent = false) {
            const res = await this.fetchAPI('/tasks', { silent: isSilent });
            if (!res) return;

            const tbody = document.getElementById('task-table-body');
            tbody.innerHTML = '';

            if (!res.data || res.data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center py-5 text-secondary">ÊöÇÊó†‰ªªÂä°ÔºåËØ∑Ê∑ªÂä†‰∏Ä‰∏™</td></tr>';
                return;
            }

            // ÊåâIDÂçáÂ∫èÊéíÂ∫è
            const tasks = res.data.sort((a, b) => a.ID - b.ID);

            tasks.forEach(task => {
                const accountName = this.accounts.find(a => a.ID === task.AccountID)?.Name || 'Êú™Áü•Ë¥¶Êà∑';
                const isRunning = task.IsRunning;
                // Êìç‰ΩúÊåâÈíÆÔºàËøêË°å/ÂÅúÊ≠¢Ôºâ
                const actionBtn = isRunning 
                    ? `<button class="btn btn-sm btn-outline-warning me-2">ÂÅúÊ≠¢ÊâßË°å</button>` 
                    : `<button class="btn btn-sm btn-outline-primary me-2">Á´ãÂç≥ÊâßË°å</button>`;

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${task.Name}</td>
                    <td>${accountName}</td>
                    <td><span class="badge bg-purple-lt">${task.Threads}</span></td>
                    <td><span class="badge bg-blue-lt">${task.SourceFolderID}</span></td>
                    <td>${task.LocalPath}</td>
                    <td>${task.Cron}</td>
                    <td class="text-end">${actionBtn}<button class="btn btn-sm btn-danger">Âà†Èô§</button></td>
                `;

                // ÁªëÂÆöÊâßË°å/ÂÅúÊ≠¢‰∫ã‰ª∂
                const btn = row.querySelector('.btn-outline-primary, .btn-outline-warning');
                btn.addEventListener('click', (e) => {
                    isRunning ? this.stopTask(task.ID, e.currentTarget) : this.executeTask(task.ID, e.currentTarget);
                });
                // ÁªëÂÆöÂà†Èô§‰∫ã‰ª∂
                row.querySelector('.btn-danger').addEventListener('click', () => this.deleteTask(task.ID));

                tbody.appendChild(row);
            });
        }

        openTaskModal() {
            const select = document.getElementById('taskAccountID');
            select.innerHTML = '';

            // Êó†Ë¥¶Êà∑Êó∂ÊèêÁ§∫
            if (this.accounts.length === 0) {
                this.showToast('ËØ∑ÂÖàÂú®‚Äú‰∫ëË¥¶Êà∑ÁÆ°ÁêÜ‚Äù‰∏≠Ê∑ªÂä†‰∏Ä‰∏™Ë¥¶Êà∑', true);
                return;
            }

            // Â°´ÂÖÖË¥¶Êà∑‰∏ãÊãâÊ°Ü
            this.accounts.forEach(acc => {
                select.insertAdjacentHTML('beforeend', `<option value="${acc.ID}">${acc.Name}</option>`);
            });

            // ÁªëÂÆöÁõÆÂΩïÊµèËßàÊåâÈíÆ‰∫ã‰ª∂
            document.getElementById('browse-folder-btn').onclick = () => {
                const accountId = document.getElementById('taskAccountID').value;
                this.openFileBrowser(accountId);
            };

            // ÂàùÂßãÂåñË°®ÂçïÈªòËÆ§ÂÄº
            document.getElementById('taskName').value = '';
            document.getElementById('sourceFolderID').value = '0';
            document.getElementById('localPath').value = '/app/strm/';
            document.getElementById('taskCron').value = '0 */2 * * *';
            document.getElementById('overwriteMode').checked = false;
            document.getElementById('taskThreads').value = 4;
            document.getElementById('threads-value').textContent = '4';
            document.getElementById('strmExtensions').value = 'mp4,mkv,ts,iso,rmvb,avi,mov,wmv,flv';
            document.getElementById('metaExtensions').value = 'jpg,jpeg,png,webp,srt,ass,sub,nfo';

            this.modals.task.show();
        }

        async saveTask() {
            const payload = {
                Name: document.getElementById('taskName').value.trim(),
                AccountID: parseInt(document.getElementById('taskAccountID').value),
                SourceFolderID: document.getElementById('sourceFolderID').value.trim(),
                LocalPath: document.getElementById('localPath').value.trim(),
                Cron: document.getElementById('taskCron').value.trim(),
                Overwrite: document.getElementById('overwriteMode').checked,
                StrmExtensions: document.getElementById('strmExtensions').value.trim(),
                MetaExtensions: document.getElementById('metaExtensions').value.trim(),
                Threads: parseInt(document.getElementById('taskThreads').value, 10),
                Enabled: true
            };

            // Âü∫Á°ÄÊ†°È™å
            if (!payload.Name || !payload.SourceFolderID || !payload.AccountID) {
                this.showToast('‰ªªÂä°Âêç„ÄÅÊâÄÂ±ûË¥¶Êà∑ÂíåÁõÆÂΩïID‰∏çËÉΩ‰∏∫Á©∫', true);
                return;
            }

            const res = await this.fetchAPI('/tasks', {
                method: 'POST',
                body: JSON.stringify(payload)
            });

            if (res) {
                this.showToast('‰ªªÂä°‰øùÂ≠òÊàêÂäü!');
                this.modals.task.hide();
                await this.loadTasks();
            }
        }

        async deleteTask(id) {
            if (!confirm('Á°ÆÂÆöË¶ÅÂà†Èô§Ê≠§‰ªªÂä°ÂêóÔºü')) return;
            const res = await this.fetchAPI(`/tasks/${id}`, { method: 'DELETE' });
            if (res) {
                this.showToast('‰ªªÂä°Âà†Èô§ÊàêÂäü!');
                await this.loadTasks();
            }
        }

        async executeTask(id, btn) {
            const originalText = btn.innerHTML;
            // ÊåâÈíÆÂä†ËΩΩÁä∂ÊÄÅ
            btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';
            btn.disabled = true;

            const res = await this.fetchAPI(`/tasks/${id}/run`, { method: 'POST' });
            if (res) {
                this.showToast(res.message);
                await this.loadTasks(true);
            } else {
                // Â§±Ë¥•Êó∂ÊÅ¢Â§çÊåâÈíÆ
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        async stopTask(id, btn) {
            const originalText = btn.innerHTML;
            // ÊåâÈíÆÂä†ËΩΩÁä∂ÊÄÅ
            btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';
            btn.disabled = true;

            const res = await this.fetchAPI(`/tasks/${id}/stop`, { method: 'POST' });
            if (res) {
                this.showToast(res.message);
                await this.loadTasks(true);
            } else {
                // Â§±Ë¥•Êó∂ÊÅ¢Â§çÊåâÈíÆ
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        openFileBrowser(accountId) {
            // ÂàùÂßãÂåñÊµèËßàÁä∂ÊÄÅÔºàÊ†πÁõÆÂΩïÔºâ
            this.browserState = {
                path: [{ id: '0', name: 'Ê†πÁõÆÂΩï' }],
                accountId: accountId
            };
            this.modals.fileBrowser.show();
            this.loadCloudFiles('0');
        }

        async loadCloudFiles(folderId, folderName) {
            // Êõ¥Êñ∞Èù¢ÂåÖÂ±ëË∑ØÂæÑ
            if (folderName) {
                const existingIdx = this.browserState.path.findIndex(p => p.id === folderId);
                if (existingIdx > -1) {
                    this.browserState.path.splice(existingIdx + 1);
                } else {
                    this.browserState.path.push({ id: folderId, name: folderName });
                }
            }

            const browserEl = document.getElementById('file-browser');
            browserEl.innerHTML = '<div class="text-center text-secondary py-5"><div class="spinner-border"></div></div>';

            const res = await this.fetchAPI(`/cloud/files?accountId=${this.browserState.accountId}&parentFileId=${folderId}`);
            browserEl.innerHTML = '';

            // Ê∏≤ÊüìÈù¢ÂåÖÂ±ë
            const pathHtml = this.browserState.path.map(p => `
                <li class="breadcrumb-item">
                    <a href="#" data-folder-id="${p.id}" data-folder-name="${p.name}">${p.name}</a>
                </li>
            `).join('');
            browserEl.insertAdjacentHTML('beforeend', `<ol class="breadcrumb breadcrumb-arrows">${pathHtml}</ol>`);

            // Èù¢ÂåÖÂ±ëÁÇπÂáª‰∫ã‰ª∂ÔºàË∑≥ËΩ¨ÁõÆÂΩïÔºâ
            browserEl.querySelector('.breadcrumb').addEventListener('click', (e) => {
                if (e.target.tagName === 'A') {
                    e.preventDefault();
                    this.loadCloudFiles(e.target.dataset.folderId, e.target.dataset.folderName);
                }
            });

            if (!res || !res.data || !res.data.fileList) {
                browserEl.insertAdjacentHTML('beforeend', '<div class="text-center text-danger py-4">Âä†ËΩΩÂ§±Ë¥•</div>');
                return;
            }

            const fileList = res.data.fileList;
            const listGroup = document.createElement('div');
            listGroup.className = 'list-group list-group-flush mt-2';

            if (fileList.length === 0) {
                listGroup.innerHTML = '<div class="text-center text-secondary py-4">Ê≠§ÁõÆÂΩï‰∏∫Á©∫</div>';
                browserEl.appendChild(listGroup);
                return;
            }

            // Ê∏≤ÊüìÊñá‰ª∂ÂàóË°®
            fileList.forEach(file => {
                const isFolder = file.type === 1;
                const icon = isFolder ? 'fa-folder text-yellow' : 'fa-file text-secondary';
                const actionBtn = isFolder ? `<button class="btn btn-sm btn-outline-primary" data-folder-id="${file.fileId}">ÈÄâÊã©Ê≠§ÁõÆÂΩï</button>` : '';

                listGroup.insertAdjacentHTML('beforeend', `
                    <div class="list-group-item">
                        <div class="row align-items-center">
                            <div class="col text-truncate">
                                <a href="#" class="text-body d-block" data-folder-id="${file.fileId}" data-folder-name="${file.filename}">
                                    <<i class="fa ${icon} me-2"></</i>${file.filename}
                                </a>
                            </div>
                            <div class="col-auto">${actionBtn}</div>
                        </div>
                    </div>
                `);
            });

            browserEl.appendChild(listGroup);

            // ÁªëÂÆöÊñá‰ª∂ÂàóË°®‰∫ã‰ª∂ÔºàËøõÂÖ•ÁõÆÂΩï/ÈÄâÊã©ÁõÆÂΩïÔºâ
            listGroup.addEventListener('click', (e) => {
                // ËøõÂÖ•Â≠êÁõÆÂΩï
                if (e.target.tagName === 'A' && e.target.closest('.list-group-item').querySelector('.fa-folder')) {
                    e.preventDefault();
                    this.loadCloudFiles(e.target.dataset.folderId, e.target.dataset.folderName);
                }
                // ÈÄâÊã©ÁõÆÂΩïÔºàËµãÂÄºÂπ∂ÂÖ≥Èó≠Ê®°ÊÄÅÊ°ÜÔºâ
                if (e.target.tagName === 'BUTTON') {
                    document.getElementById('sourceFolderID').value = e.target.dataset.folderId;
                    this.modals.fileBrowser.hide();
                    this.showToast(`Â∑≤ÈÄâÊã©ÁõÆÂΩï ID: ${e.target.dataset.folderId}`);
                }
            });
        }

        showToast(msg, isError = false) {
            const type = isError ? 'danger' : 'success';
            const icon = isError ? 'fa-exclamation-circle' : 'fa-check';
            
            // ÂàõÂª∫toastÂÆπÂô®Ôºà‰∏çÂ≠òÂú®ÂàôÂàõÂª∫Ôºâ
            let container = document.querySelector('.toast-container');
            if (!container) {
                container = document.createElement('div');
                container.className = 'toast-container position-fixed top-0 end-0 p-3';
                container.style.zIndex = '1080';
                document.body.appendChild(container);
            }

            // ÂàõÂª∫toastÂÖÉÁ¥†
            const toastHtml = `
                <div class="toast show" role="alert" aria-live="assertive" aria-atomic="true" 
                     data-bs-autohide="true" data-bs-delay="3000">
                    <div class="toast-header text-bg-${type}">
                        <<i class="fa-solid ${icon} me-2"></</i>
                        <strong class="me-auto">ÈÄöÁü•</strong>
                    </div>
                    <div class="toast-body">${msg}</div>
                </div>
            `;
            container.insertAdjacentHTML('beforeend', toastHtml);

            // ÂàùÂßãÂåñÂπ∂ÊòæÁ§∫toastÔºåÈöêËóèÂêéÁßªÈô§
            const toastEl = container.lastElementChild;
            const toast = new bootstrap.Toast(toastEl);
            toast.show();
            toastEl.addEventListener('hidden.bs.toast', () => toastEl.remove());
        }
    }

    // È°µÈù¢Âä†ËΩΩÂÆåÊàêÂêéÂàùÂßãÂåñÂ∫îÁî®
    document.addEventListener('DOMContentLoaded', () => { new App().run(); });
    </script>
</body>
</html>
