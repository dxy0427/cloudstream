name: 手动构建 YSTRM 镜像到 GHCR

# 仅支持手动触发，删除自动触发条件（push/pull_request）
on:
  workflow_dispatch:  # 手动触发关键字，支持在GitHub页面手动启动
    inputs:
      # 可选：添加自定义输入参数（比如指定镜像标签、构建平台）
      image-tag:
        description: '镜像标签（默认：latest）'
        required: false
        default: 'latest'
      platform:
        description: '构建平台（默认：linux/amd64，可选：linux/amd64,linux/arm64）'
        required: false
        default: 'linux/amd64'

jobs:
  build-and-push-ghcr:
    runs-on: ubuntu-latest
    permissions:
      packages: write  # 允许推送镜像到GHCR
      contents: read   # 允许读取仓库代码
    steps:
      - name: 检查代码
        uses: actions/checkout@v4

      - name: 设置 Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: 登录 GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}  # GitHub自动生成的令牌，无需手动配置

      - name: 提取镜像标签
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: |
            ghcr.io/${{ github.actor }}/cloudstream  # 你的GHCR镜像名（格式：ghcr.io/用户名/镜像名）
          tags: |
            ${{ github.event.inputs.image-tag }}  # 手动输入的标签
            ${{ github.sha }}  # commit哈希标签（唯一标识版本）
          flavor: |
            latest=true

      - name: 构建并推送镜像
        uses: docker/build-push-action@v5
        with:
          context: .  # 构建上下文：项目根目录
          file: ./Dockerfile  # Dockerfile路径（确保与项目中一致）
          push: true  # 始终推送镜像（仅手动触发，无需判断）
          tags: ${{ steps.meta.outputs.tags }}  # 镜像标签（手动输入+commit哈希）
          labels: ${{ steps.meta.outputs.labels }}  # 自动生成的镜像标签
          platforms: ${{ github.event.inputs.platform }}  # 手动选择的构建平台
          cache-from: type=gha  # 利用GitHub Actions缓存加速构建
          cache-to: type=gha,mode=max  # 最大化缓存，下次构建更快